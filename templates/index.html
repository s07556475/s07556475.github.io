<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©ºé—´è®¡é‡åˆ†æå¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #ecf0f1;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background: #d6dbdf;
            border-color: #2980b9;
        }
        
        .upload-area i {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        select:focus, input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .results {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #ecf0f1;
        }
        
        .results h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        th {
            background: #34495e;
            color: white;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ ç©ºé—´è®¡é‡åˆ†æå¹³å°</h1>
            <p>åŸºäºPythonå’ŒWebæŠ€æœ¯çš„ç©ºé—´è®¡é‡ç»æµå­¦åˆ†æå·¥å…·</p>
        </div>
        
        <div class="content">
            <!-- æ•°æ®ä¸Šä¼ éƒ¨åˆ† -->
            <div class="section">
                <h2>ğŸ“ æ•°æ®ä¸Šä¼ </h2>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div>ğŸ“Š</div>
                    <h3>ç‚¹å‡»ä¸Šä¼ æ•°æ®æ–‡ä»¶</h3>
                    <p>æ”¯æŒ Excel (.xlsx, .xls) å’Œ CSV æ ¼å¼</p>
                    <input type="file" id="fileInput" style="display: none" onchange="uploadFile()">
                </div>
                <div id="uploadStatus"></div>
                <div id="dataInfo" style="display: none;">
                    <h3>æ•°æ®ä¿¡æ¯</h3>
                    <div id="dataDetails"></div>
                </div>
            </div>
            
            <!-- è«å…°æŒ‡æ•°åˆ†æ -->
            <div class="section">
                <h2>ğŸ“ˆ ç©ºé—´è‡ªç›¸å…³åˆ†æ</h2>
                <div class="form-group">
                    <label>é€‰æ‹©åˆ†æå˜é‡:</label>
                    <select id="moranVariable">
                        <option value="">-- è¯·é€‰æ‹©å˜é‡ --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©å¹´ä»½ (å¯é€‰):</label>
                    <select id="moranYears" multiple>
                        <option value="all">æ‰€æœ‰å¹´ä»½</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="runMoranAnalysis()">è¿è¡Œè«å…°åˆ†æ</button>
                <div id="moranResults"></div>
            </div>
            
            <!-- ç©ºé—´å›å½’åˆ†æ -->
            <div class="section">
                <h2>ğŸ”¬ ç©ºé—´å›å½’åˆ†æ</h2>
                <div class="form-group">
                    <label>å› å˜é‡:</label>
                    <select id="dependentVar">
                        <option value="">-- é€‰æ‹©å› å˜é‡ --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è‡ªå˜é‡ (å¤šé€‰):</label>
                    <select id="independentVars" multiple>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ¨¡å‹ç±»å‹:</label>
                    <select id="modelType">
                        <option value="sdm">ç©ºé—´æœå®¾æ¨¡å‹ (SDM)</option>
                        <option value="sar">ç©ºé—´è‡ªå›å½’æ¨¡å‹ (SAR)</option>
                        <option value="sem">ç©ºé—´è¯¯å·®æ¨¡å‹ (SEM)</option>
                    </select>
                </div>
                <button class="btn btn-warning" onclick="runSpatialRegression()">è¿è¡Œç©ºé—´å›å½’</button>
                <div id="regressionResults"></div>
            </div>
            
            <!-- åŠ è½½åŠ¨ç”» -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>
    </div>

    <script>
        let currentDataInfo = null;
        
        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('uploadStatus');
            const loading = document.getElementById('loading');
            
            if (!file) return;
            
            loading.style.display = 'block';
            statusDiv.innerHTML = '';
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await axios.post('/api/upload', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                if (response.data.success) {
                    statusDiv.innerHTML = `<div class="alert alert-success">${response.data.message}</div>`;
                    currentDataInfo = response.data.data_info;
                    updateDataInfo();
                    updateVariableSelects();
                    document.getElementById('dataInfo').style.display = 'block';
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-error">${response.data.message}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-error">ä¸Šä¼ å¤±è´¥: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // æ›´æ–°æ•°æ®ä¿¡æ¯æ˜¾ç¤º
        function updateDataInfo() {
            const detailsDiv = document.getElementById('dataDetails');
            detailsDiv.innerHTML = `
                <p><strong>æ•°æ®ç»´åº¦:</strong> ${currentDataInfo.shape[0]} è¡Œ Ã— ${currentDataInfo.shape[1]} åˆ—</p>
                <p><strong>å¯ç”¨å˜é‡:</strong> ${currentDataInfo.columns.join(', ')}</p>
                <p><strong>å¹´ä»½èŒƒå›´:</strong> ${currentDataInfo.years.length > 0 ? currentDataInfo.years.join(', ') : 'æ— å¹´ä»½ä¿¡æ¯'}</p>
            `;
        }
        
        // æ›´æ–°å˜é‡é€‰æ‹©ä¸‹æ‹‰æ¡†
        function updateVariableSelects() {
            const moranSelect = document.getElementById('moranVariable');
            const dependentSelect = document.getElementById('dependentVar');
            const independentSelect = document.getElementById('independentVars');
            const yearsSelect = document.getElementById('moranYears');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            moranSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å˜é‡ --</option>';
            dependentSelect.innerHTML = '<option value="">-- é€‰æ‹©å› å˜é‡ --</option>';
            independentSelect.innerHTML = '';
            yearsSelect.innerHTML = '<option value="all">æ‰€æœ‰å¹´ä»½</option>';
            
            // æ·»åŠ å˜é‡é€‰é¡¹
            currentDataInfo.columns.forEach(col => {
                if (col !== 'id' && col !== 'city') {
                    const option1 = new Option(col, col);
                    const option2 = new Option(col, col);
                    const option3 = new Option(col, col);
                    moranSelect.add(option1);
                    dependentSelect.add(option2);
                    independentSelect.add(option3);
                }
            });
            
            // æ·»åŠ å¹´ä»½é€‰é¡¹
            currentDataInfo.years.forEach(year => {
                const option = new Option(year, year);
                yearsSelect.add(option);
            });
        }
        
        // è¿è¡Œè«å…°åˆ†æ
        async function runMoranAnalysis() {
            const variable = document.getElementById('moranVariable').value;
            const yearsSelect = document.getElementById('moranYears');
            const selectedYears = Array.from(yearsSelect.selectedOptions).map(opt => opt.value);
            
            if (!variable) {
                alert('è¯·é€‰æ‹©åˆ†æå˜é‡');
                return;
            }
            
            const loading = document.getElementById('loading');
            const resultsDiv = document.getElementById('moranResults');
            
            loading.style.display = 'block';
            resultsDiv.innerHTML = '';
            
            try {
                const response = await axios.post('/api/moran', {
                    variable: variable,
                    years: selectedYears.includes('all') ? null : selectedYears
                });
                
                if (response.data.success) {
                    displayMoranResults(response.data.results, variable);
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-error">${response.data.message}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-error">åˆ†æå¤±è´¥: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºè«å…°åˆ†æç»“æœ
        function displayMoranResults(results, variable) {
            const resultsDiv = document.getElementById('moranResults');
            let html = `<h3>è«å…°æŒ‡æ•°åˆ†æç»“æœ - ${variable}</h3>`;
            
            // åˆ›å»ºè¡¨æ ¼
            html += `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>å¹´ä»½</th>
                                <th>è«å…°æŒ‡æ•° I</th>
                                <th>P å€¼</th>
                                <th>Z å¾—åˆ†</th>
                                <th>æ˜¾è‘—æ€§</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (const [year, result] of Object.entries(results)) {
                const significance = result.p_value < 0.01 ? '***' : 
                                   result.p_value < 0.05 ? '**' : 
                                   result.p_value < 0.1 ? '*' : 'ä¸æ˜¾è‘—';
                const color = result.p_value < 0.05 ? '#27ae60' : '#e74c3c';
                
                html += `
                    <tr>
                        <td>${year}</td>
                        <td>${result.moran_i.toFixed(4)}</td>
                        <td>${result.p_value.toFixed(4)}</td>
                        <td>${result.z_score.toFixed(4)}</td>
                        <td style="color: ${color}; font-weight: bold;">${significance}</td>
                    </tr>
                `;
            }
            
            html += `</tbody></table></div>`;
            resultsDiv.innerHTML = html;
        }
        
        // è¿è¡Œç©ºé—´å›å½’
        async function runSpatialRegression() {
            const dependentVar = document.getElementById('dependentVar').value;
            const independentVarsSelect = document.getElementById('independentVars');
            const independentVars = Array.from(independentVarsSelect.selectedOptions).map(opt => opt.value);
            const modelType = document.getElementById('modelType').value;
            
            if (!dependentVar || independentVars.length === 0) {
                alert('è¯·é€‰æ‹©å› å˜é‡å’Œè‡³å°‘ä¸€ä¸ªè‡ªå˜é‡');
                return;
            }
            
            const loading = document.getElementById('loading');
            const resultsDiv = document.getElementById('regressionResults');
            
            loading.style.display = 'block';
            resultsDiv.innerHTML = '';
            
            try {
                const response = await axios.post('/api/regression', {
                    dependent_var: dependentVar,
                    independent_vars: independentVars,
                    model_type: modelType
                });
                
                if (response.data.success) {
                    displayRegressionResults(response.data.results, modelType);
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-error">${response.data.message}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-error">å›å½’åˆ†æå¤±è´¥: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºå›å½’ç»“æœ
        function displayRegressionResults(results, modelType) {
            const resultsDiv = document.getElementById('regressionResults');
            let html = `<h3>ç©ºé—´å›å½’ç»“æœ - ${modelType.toUpperCase()} æ¨¡å‹</h3>`;
            
            // æ¨¡å‹ç»Ÿè®¡ä¿¡æ¯
            html += `
                <div class="results">
                    <p><strong>å¯¹æ•°ä¼¼ç„¶å€¼:</strong> ${results.log_likelihood.toFixed(4)}</p>
                    ${results.r2 ? `<p><strong>RÂ²:</strong> ${results.r2.toFixed(4)}</p>` : ''}
                </div>
            `;
            
            // ç³»æ•°è¡¨æ ¼
            html += `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>å˜é‡</th>
                                <th>ç³»æ•°</th>
                                <th>æ ‡å‡†è¯¯</th>
                                <th>P å€¼</th>
                                <th>æ˜¾è‘—æ€§</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            results.coefficients.forEach(coef => {
                const significance = coef.p_value < 0.01 ? '***' : 
                                   coef.p_value < 0.05 ? '**' : 
                                   coef.p_value < 0.1 ? '*' : '';
                const color = coef.p_value < 0.05 ? '#27ae60' : '#e74c3c';
                
                html += `
                    <tr>
                        <td>${coef.variable}</td>
                        <td>${coef.coefficient.toFixed(6)}</td>
                        <td>${coef.std_error.toFixed(6)}</td>
                        <td>${coef.p_value.toFixed(4)}</td>
                        <td style="color: ${color}; font-weight: bold;">${significance}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div>`;
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>